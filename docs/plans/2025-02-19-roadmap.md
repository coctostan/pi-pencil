# pi-pencil Roadmap

A pi package that integrates [Pencil](https://pencil.dev) — a local vector design tool — with pi via Pencil's MCP server.

## Goal

Give pi the same design capabilities that Claude Code and Cursor get from Pencil, then go beyond with pi-native enhancements.

---

## Phase 1 — MVP: Claude Code Parity

**Status:** Not started

Build a self-contained pi extension that connects to Pencil's local MCP server (stdio transport), registers all 14 Pencil tools as native pi tools, and injects Pencil's system prompt instructions. The LLM gets the exact same design capabilities as Claude Code.

Key feature: **`/pencil` mode toggle** — tools are registered but inactive by default. `/pencil` activates them (adds to active tools, injects system prompt, shows status widget). `/pencil` again deactivates. Zero context cost when not in use.

**Deliverables:**
- MCP client using `@modelcontextprotocol/sdk` (stdio transport)
- Dynamic tool registration of all 14 Pencil tools
- `/pencil` command to toggle design mode on/off via `setActiveTools`
- System prompt injection with Pencil's instructions when active
- Status widget showing connection state
- Graceful error handling (Pencil not running, connection lost)
- Cross-platform binary detection (macOS arm64/x64, Linux, Windows)

**See:** [Phase 1 Detailed Design](./2025-02-19-phase1-design.md)

---

## Phase 2 — Pi-Enhanced Experience

**Status:** Not started  
**Depends on:** Phase 1

Leverage pi's TUI capabilities to create an experience that surpasses Claude Code's.

**Deliverables:**
- **Inline screenshot rendering** — After `get_screenshot` and `batch_design` calls, render the design preview directly in the terminal using pi's `Image` TUI component. No context-switching to Pencil window to see results.
- **`/pencil preview [nodeId]`** — On-demand screenshot rendering in an overlay.
- **`/pencil layers`** — Interactive overlay showing the design's node tree (from `batch_get`). Navigate with arrow keys, select elements to give the LLM context about what you're pointing at.
- **`/pencil variables`** — Quick view of current design tokens in an overlay.
- **`/pencil status`** — Connection info, active file, selection state.

---

## Phase 3 — Design Workflow Skills

**Status:** Not started  
**Depends on:** Phase 1

Packaged skills that guide the LLM through common design workflows with best practices.

**Deliverables:**
- **Design-to-code skill** — Guided workflow: screenshot design → analyze structure → generate framework-specific code (React/Vue/Svelte + Tailwind/CSS). Includes prompting best practices from Pencil docs.
- **Code-to-design skill** — Import existing components into Pencil: read code → analyze structure → recreate visually via `batch_design`.
- **Design review skill** — Screenshot → analyze against a spec or reference image → report issues (spacing, alignment, color consistency, accessibility).
- **Design token sync skill** — Bidirectional sync between Pencil variables and CSS/Tailwind config. Detect drift, apply updates.

---

## Phase 4 — Direct .pen File Manipulation

**Status:** Not started  
**Depends on:** Phase 1

Read and write `.pen` files directly as JSON, without requiring Pencil to be running.

**Use cases:**
- CI/CD design validation (check variables, component structure)
- Offline batch modifications
- Design system auditing
- Scripted design generation

**Deliverables:**
- **`pen_read` tool** — Parse and query `.pen` JSON (nodes, variables, themes, components).
- **`pen_write` tool** — Create or modify `.pen` files with schema validation.
- **`pen_validate` tool** — Validate `.pen` file against TypeScript schema, report issues.
- Schema-aware: uses the full `.pen` TypeScript schema for validation and autocompletion guidance.

---

## Phase 5 — Batch Automation

**Status:** Not started  
**Depends on:** Phase 1, Phase 4

Programmatic design generation at scale using Pencil's CLI.

**Deliverables:**
- **`/pencil batch`** — Generate and run `pencil --agent-config` configs from pi. Spawn multiple Pencil windows with different prompts/models.
- **Design system generation pipelines** — Generate complete component libraries from specs.
- **Multi-variant generation** — Create design variations (themes, responsive breakpoints, A/B test variants) in parallel.
- **Integration with pi subagents** — Dispatch design tasks to parallel subagents, each working on different screens/components.

---

## Architecture Notes

### Pencil MCP Server

- **Transport:** stdio (native binary)
- **Binary:** `/Applications/Pencil.app/Contents/Resources/app.asar.unpacked/out/mcp-server-darwin-arm64`
- **Args:** `--app desktop`
- **Protocol:** JSON-RPC 2.0 over stdin/stdout, MCP protocol version `2024-11-05`
- **Server info:** `pencil v1.0.0`
- **Capabilities:** logging, tools

### 14 MCP Tools

| Tool | Purpose |
|------|---------|
| `batch_design` | Insert/copy/update/replace/move/delete/image operations (max 25 per call) |
| `batch_get` | Read nodes by pattern search or ID |
| `find_empty_space_on_canvas` | Find placement locations for new elements |
| `get_editor_state` | Current file, selection, editor context |
| `get_guidelines` | Design rules for specific topics (code, table, tailwind, landing-page, design-system) |
| `get_screenshot` | Render visual preview of a node |
| `get_style_guide` | Style inspiration by tags or name |
| `get_style_guide_tags` | Available style guide tags |
| `get_variables` | Read design tokens/themes |
| `open_document` | Open or create `.pen` files |
| `replace_all_matching_properties` | Bulk property replacement across node tree |
| `search_all_unique_properties` | Find unique property values across node tree |
| `set_variables` | Create/update design tokens/themes |
| `snapshot_layout` | Analyze computed layout, detect problems |

### Registration in Claude Code

Pencil auto-registers in `~/.claude.json` under `mcpServers.pencil`:

```json
{
  "pencil": {
    "command": "/Applications/Pencil.app/Contents/Resources/app.asar.unpacked/out/mcp-server-darwin-arm64",
    "args": ["--app", "desktop"],
    "env": {},
    "type": "stdio"
  }
}
```
